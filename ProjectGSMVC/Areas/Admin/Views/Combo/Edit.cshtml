@model ProjectGSMVC.Areas.Admin.Models.ComboViewModel

<div class="container" asp-action="Edit" method="post" enctype="multipart/form-data">
    <div class="card shadow-sm p-4">
        <h4 class="text-primary">Chỉnh sửa Combo</h4>

        <!-- Nhập tên Combo -->
        <div class="mb-3">
            <label class="form-label">Tên Combo</label>
            <input type="text" class="form-control" id="TenCombo" value="@Model.TenCombo" />
        </div>

        <!-- Nhập giá -->
        <div class="mb-3">
            <label class="form-label">Giá (VND)</label>
            <input type="number" class="form-control" id="Gia" value="@Model.Gia" min="1000" />
        </div>

        <!-- Nhập mô tả -->
        <div class="mb-3">
            <label class="form-label">Mô tả</label>
            <textarea class="form-control" id="MoTa" rows="3">@Model.MoTa</textarea>
        </div>

        <!-- Hình ảnh -->
        <div class="mb-3">
            <label class="form-label">Hình ảnh</label><br>
            <img id="preview" src="@(string.IsNullOrEmpty(@Model.HinhAnh) ? "/images/default-combo.png" : $"data:image/jpeg;base64,{@Model.HinhAnh}")"
                 class="rounded border mb-2"
                 style="width: 100px; height: 100px; object-fit: cover;">
            <input type="file" id="HinhFile" class="form-control" />
        </div>

        <hr>

        <!-- Danh sách sản phẩm -->
        <h5 class="mt-3">📦 Danh sách sản phẩm trong Combo:</h5>
        <div id="sanPhamList">
            @if (ViewBag.SanPhams != null)
            {
                foreach (var sanPham in ViewBag.SanPhams)
                {
                    var isChecked = Model.ChiTietCombos.Any(x => x.SanPhamId == sanPham.Id);
                    var soLuong = Model.ChiTietCombos.FirstOrDefault(x => x.SanPhamId == sanPham.Id)?.SoLuong ?? 1;

                    <div class="form-group">
                        <input type="checkbox" class="sanPhamCheckbox" data-id="@sanPham.Id" @(isChecked ? "checked" : "") />
                        <label>@sanPham.TenSanPham</label>
                        <input type="number" class="form-control soLuongSanPham" data-id="@sanPham.Id"
                               placeholder="Số lượng" min="1" value="@soLuong" @(isChecked ? "" : "disabled") />
                    </div>
                }
            }
            else
            {
                <p class="text-danger">Không có sản phẩm nào để chọn.</p>
            }
        </div>

        <!-- Nút lưu -->
        <div class="text-end mt-3">
            <button type="button" class="btn btn-primary" id="LuuCombo">💾 Lưu thay đổi</button>

            
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    $(document).ready(function () {
        $(".sanPhamCheckbox").change(function () {
            var isChecked = $(this).is(":checked");
            var sanPhamId = $(this).data("id");
            $(".soLuongSanPham[data-id='" + sanPhamId + "']").prop("disabled", !isChecked);
        });

        $("#LuuCombo").click(function () {
            console.log("Nút lưu đã được bấm!"); // Kiểm tra sự kiện click

            var comboData = {
                Id: @Model.Id,
                TenCombo: $("#TenCombo").val(),
                Gia: $("#Gia").val(),
                MoTa: $("#MoTa").val(),
                HinhAnh: null,
                ChiTietCombos: []
            };

            // Đọc danh sách sản phẩm đã chọn
            $(".sanPhamCheckbox:checked").each(function () {
                var sanPhamId = $(this).data("id");
                var soLuong = $(".soLuongSanPham[data-id='" + sanPhamId + "']").val();
                if (soLuong && soLuong > 0) {
                    comboData.ChiTietCombos.push({ SanPhamId: sanPhamId, SoLuong: soLuong });
                }
            });

            // Kiểm tra hình ảnh
            var imageFile = $("#HinhFile")[0].files[0];
            if (imageFile) {
                var reader = new FileReader();
                reader.readAsDataURL(imageFile);
                reader.onload = function () {
                    comboData.HinhAnh = reader.result.split(",")[1];
                    console.log("Dữ liệu trước khi gửi:", comboData); // Kiểm tra dữ liệu JSON
                    updateCombo(comboData);
                };
            } else {
                console.log("Dữ liệu trước khi gửi:", comboData); // Kiểm tra dữ liệu JSON
                updateCombo(comboData);
            }
        });

        function updateCombo(data) {
            $.ajax({
                url: "/Admin/Combo/Edit/" + data.Id,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    alert("Cập nhật thành công!");
                    window.location.href = "/Admin/Combo/Index";
                },
                error: function () {
                    alert("Có lỗi xảy ra!");
                }
            });
        }
    });
</script>
