@model IEnumerable<ProjectGSMVC.Areas.Admin.ViewModels.TaiKhoanViewModel>

@{
    ViewData["Title"] = "Quản lý Khách Hàng";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}
<!-- Thêm vào phần <head> của bạn -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<div class="container">
    <h2 class="mt-3">Quản lý Khách Hàng</h2>
    <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#createModal">Thêm Khách Hàng</button>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Mã Tài Khoản</th>
                <th>Tên Tài Khoản</th>
                <th>Email</th>
                <th>Số Điện Thoại</th>
                <th>Trạng Thái</th>
                <th>Hình Ảnh</th>
                <th>Hành Động</th>
            </tr>
        </thead>
        <tbody id="customerTableBody">
            @foreach (var taiKhoan in Model)
            {
                <tr id="row-@taiKhoan.IdtaiKhoan">
                    <td>@taiKhoan.IdtaiKhoan</td>
                    <td>@taiKhoan.TenTaiKhoan</td>
                    <td>@taiKhoan.Email</td>
                    <td>@taiKhoan.Sdt</td>
                    <td>@(taiKhoan.TrangThai == 1 ? "Hoạt động" : "Không hoạt động")</td>
                    <td>
                        @if (!string.IsNullOrEmpty(taiKhoan.Hinh))
                        {
                            <img src="~/@Url.Content($"images/AnhTaiKhoan/{System.IO.Path.GetFileName(taiKhoan.Hinh)}")" alt="Avatar" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                        }
                        else
                        {
                            <span>Chưa có ảnh</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-warning edit-btn" data-id="@taiKhoan.IdtaiKhoan">Sửa</button>
                        <button class="btn btn-danger delete-btn" data-id="@taiKhoan.IdtaiKhoan">Xóa</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal Thêm -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Thêm Khách Hàng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createForm" enctype="multipart/form-data">
                    <input type="hidden" name="VaiTro" value="1" />
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="createIdtaiKhoan">Mã Tài Khoản</label>
                                <input type="text" class="form-control" id="createIdtaiKhoan" name="IdtaiKhoan" readonly>
                            </div>
                            <div class="form-group">
                                <label for="createTenTaiKhoan">Tên Tài Khoản</label>
                                <input type="text" class="form-control" id="createTenTaiKhoan" name="TenTaiKhoan" required>
                            </div>
                            <div class="form-group">
                                <label for="createMatKhau">Mật Khẩu</label>
                                <input type="password" class="form-control" id="createMatKhau" name="MatKhau" required>
                            </div>
                            <div class="form-group">
                                <label for="createEmail">Email</label>
                                <input type="email" class="form-control" id="createEmail" name="Email" required>
                            </div>
                            <div class="form-group">
                                <label for="createAnh">Ảnh Đại Diện</label>
                                <input type="file" class="form-control" id="createAnh" name="Anh" accept="image/*">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="createTenNguoiDung">Tên Người Dùng</label>
                                <input type="text" class="form-control" id="createTenNguoiDung" name="TenNguoiDung" required>
                            </div>
                            <div class="form-group">
                                <label for="createSdt">Số Điện Thoại</label>
                                <input type="text" class="form-control" id="createSdt" name="Sdt" required>
                            </div>
                            <div class="form-group">
                                <label for="createDiaChi">Địa Chỉ</label>
                                <input type="text" class="form-control" id="createDiaChi" name="DiaChi" required>
                            </div>
                            <div class="form-group">
                                <label for="createNgaySinh">Ngày Sinh</label>
                                <input type="date" class="form-control" id="createNgaySinh" name="NgaySinh" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveCreate">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sửa -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Sửa Khách Hàng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm" enctype="multipart/form-data">
                    <input type="hidden" id="editIdtaiKhoan" name="IdtaiKhoan">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editTenTaiKhoan">Tên Tài Khoản</label>
                                <input type="text" class="form-control" id="editTenTaiKhoan" name="TenTaiKhoan" required>
                            </div>
                            <div class="form-group">
                                <label for="editMatKhau">Mật Khẩu</label>
                                <input type="password" class="form-control" id="editMatKhau" name="MatKhau" required>
                            </div>
                            <div class="form-group">
                                <label for="editEmail">Email</label>
                                <input type="email" class="form-control" id="editEmail" name="Email" required>
                            </div>
                            <div class="form-group">
                                <label for="editAnh">Ảnh Đại Diện</label>
                                <input type="file" class="form-control" id="editAnh" name="Anh" accept="image/*">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editTenNguoiDung">Tên Người Dùng</label>
                                <input type="text" class="form-control" id="editTenNguoiDung" name="TenNguoiDung" required>
                            </div>
                            <div class="form-group">
                                <label for="editSdt">Số Điện Thoại</label>
                                <input type="text" class="form-control" id="editSdt" name="Sdt" required>
                            </div>
                            <div class="form-group">
                                <label for="editDiaChi">Địa Chỉ</label>
                                <input type="text" class="form-control" id="editDiaChi" name="DiaChi" required>
                            </div>
                            <div class="form-group">
                                <label for="editNgaySinh">Ngày Sinh</label>
                                <input type="date" class="form-control" id="editNgaySinh" name="NgaySinh" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" id="saveEdit">Lưu</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            const apiBaseUrl = "http://localhost:5030/api/TaiKhoan";

            // Tự động tạo mã tài khoản khi mở modal thêm
            $("#createModal").on("show.bs.modal", function () {
                $.ajax({
                    url: `${apiBaseUrl}/GenerateId`,
                    type: "GET",
                    success: function (response) {
                        $("#createIdtaiKhoan").val(response); 
                    },
                    error: function () {
                        Swal.fire({
                            icon: "error",
                            title: "Lỗi",
                            text: "Không thể tạo mã tài khoản.",
                        });
                    },
                });
            });

            $("#saveCreate").click(function () {
                const formData = new FormData($("#createForm")[0]); // Thu thập dữ liệu từ form

                $.ajax({
                    url: apiBaseUrl,
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        Swal.fire({
                            icon: "success",
                            title: "Thành công",
                            text: "Tài khoản đã được thêm!",
                        }).then(() => location.reload());
                    },
                    error: function (xhr) {
                        Swal.fire({
                            icon: "error",
                            title: "Lỗi",
                            text: xhr.responseJSON?.ErrorMessage || "Không thể thêm tài khoản.",
                        });
                    },
                });
            });


            $(document).on("click", ".edit-btn", function () {
                const id = $(this).data("id"); // Lấy ID từ data-id
                console.log("ID được nhấn: ", id); // Log để kiểm tra

                $.ajax({
                    url: `${apiBaseUrl}/${id}`,
                    type: "GET",
                    success: function (response) {
                        console.log("Response từ API:", response); // Log dữ liệu trả về

                        // Gán dữ liệu vào modal
                        const idtaiKhoan = response.idtaiKhoan || "ID không xác định";
                        $("#editIdtaiKhoan").val(idtaiKhoan);
                        $("#editTenTaiKhoan").val(response.tenTaiKhoan);
                        $("#editMatKhau").val(response.matKhau);
                        $("#editEmail").val(response.email);
                        $("#editTenNguoiDung").val(response.tenNguoiDung);
                        $("#editSdt").val(response.sdt);
                        $("#editDiaChi").val(response.diaChi);

                        const ngaySinh = response.ngaySinh ? response.ngaySinh.split("T")[0] : "";
                        $("#editNgaySinh").val(ngaySinh);

                        // Hiển thị modal
                        $("#editModal").modal("show");
                    },
                    error: function () {
                        Swal.fire({
                            icon: "error",
                            title: "Lỗi",
                            text: "Không thể tải thông tin tài khoản.",
                        });
                    },
                });
            });





            $("#saveEdit").click(function () {
                const id = $("#editIdtaiKhoan").val();
                const formData = new FormData($("#editForm")[0]);
                $.ajax({
                    url: `${apiBaseUrl}/${id}`,
                    type: "PUT",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        Swal.fire({
                            icon: "success",
                            title: "Thành công",
                            text: "Tài khoản đã được cập nhật!",
                        }).then(() => location.reload());
                    },
                    error: function (xhr) {
                        Swal.fire({
                            icon: "error",
                            title: "Lỗi",
                            text: xhr.responseJSON?.ErrorMessage || "Không thể cập nhật tài khoản.",
                        });
                    },
                });
            });

            // Xóa tài khoản
            $(document).on("click", ".delete-btn", function () {
                const id = $(this).data("id");
                Swal.fire({
                    title: "Bạn có chắc muốn xóa?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Xóa",
                    cancelButtonText: "Hủy",
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${apiBaseUrl}/${id}`,
                            type: "DELETE",
                            success: function () {
                                Swal.fire({
                                    icon: "success",
                                    title: "Thành công",
                                    text: "Tài khoản đã được xóa!",
                                }).then(() => $(`#row-${id}`).remove());
                            },
                            error: function (xhr) {
                                Swal.fire({
                                    icon: "error",
                                    title: "Lỗi",
                                    text: xhr.responseJSON?.ErrorMessage || "Không thể xóa tài khoản.",
                                });
                            },
                        });
                    }
                });
            });
        });
    </script>
}
