@using ProjectGSMAUI.Api.Data.Entities
@using ProjectGSMVC.Areas.Admin.ViewModels
@using ProjectGSMAUI.Api.Modal
@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var ListPhim = ViewData["ListPhim"] as List<PhimView>;
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<!-- Dropzone CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">

<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal">
    Open modal
</button>
<div class="pd-ltr-20 xs-pd-20-10">
    <div class="min-height-200px">
        <div class="page-header">
            <div class="row">
                <div class="col-md-12 col-sm-12">
                    <div class="title">
                        <h4>Quản lý Phim</h4>
                    </div>
                    <nav aria-label="breadcrumb" role="navigation">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="index.html">Trang Chủ</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                Quản lý Phim
                            </li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
        <!-- Slide Top effect -->
        <div class="container mt-3" style="margin-top: 40px; margin-bottom: 40px">
            <div class="container">
                <div class="row">
                    <div class="col-6">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal" id="ThemGiamGiaModal">
                            Thêm Phim Mới
                        </button>
                    </div>
                    <div class="col-6" style="text-align: right">
                        <input type="text" name="searching" id="Searching" placeholder="Gõ Tên Giảm Giá" style="height: 40px; width: 200px; border-radius: 5px; padding-left:20px; padding-right: 20px" />
                        <button type="submit" class="btn btn-secondary" id="ClickSearch">Tìm kiếm</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row clearfix" id="ListGiamGiaTable">
            @if (ListPhim != null && ListPhim.Any())
            {
                @foreach (var item in ListPhim)
                {
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-30">
                        <div class="da-card">
                            <div class="da-card-photo">
                                <div style="height:400px; border-bottom: 1px solid grey; width: 300px">
                                    @if(item.HinhAnh!=null)
                                    {
                                        <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.HinhAnh)" alt="" style="width:300px; height:100%" />
                                    }
                                    else
                                    {
                                        <img src="https://bcp.cdnchinhphu.vn/334894974524682240/2023/4/19/nguyen-tac-phan-loai-phim-1681809768732597109738-113-0-762-1038-crop-16818097747631607022540-1681869948152579212044.jpg" alt="" style="width:300px; height:100%" />
                                    }
                                </div>
                                <div class="da-overlay da-slide-top">
                                    <div class="da-social">
                                        <ul class="clearfix" style="margin-left: -25px">
                                            <li>
                                                <a href="#" class="detail-discount" data-id="@item.Id" data-bs-toggle="modal" data-bs-target="#myModal2">
                                                    <i class="bi bi-info-circle"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" class="edit-discount" data-id="@item.Id" data-bs-toggle="modal" data-bs-target="#myModal1">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" class="delete-discount" data-id="@item.Id"><i class="bi bi-x"></i></a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="da-card-content">
                                <h5 class="h5 mb-10">@item.TenPhim</h5>
                                <h5 class="h5 mb-10"><strong>Đạo Diễn: &nbsp</strong><strong style="color:red">@item.DaoDien &nbsp; </strong></h5>
                                <p class="mb-0"><strong>Từ &nbsp</strong>@item.NgayKhoiChieu &nbsp<strong>Đến </strong>@item.NgayKetThuc</p>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <p class="text-center">Không tìm thấy phim nào.</p>
                </div>
            }
        </div>
    </div>
</div>
<div class="modal" id="myModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="text-align: center">
                <h3>Thêm Mới Phim</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="container">
                    <div class ="row">
                        <div class="col-md-6">
                            <div id="InfoPhim" class="double-border">
                                <h3>Thông Tin Phim</h3>
                                <form id="phimForm">
                                    <div class="mb-3">
                                        <label class="form-label">Tên Phim</label>
                                        <input type="text" class="form-control" name="TenPhim" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Thể Loại</label>
                                        <input type="text" class="form-control" name="TheLoai" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Thời Lượng (phút)</label>
                                        <input type="number" class="form-control" name="ThoiLuong" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Đạo Diễn</label>
                                        <input type="text" class="form-control" name="DaoDien" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Giới Hạn Độ Tuổi</label>
                                        <input type="number" class="form-control" name="GioiHanDoTuoi" min="0" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ngày Khởi Chiếu</label>
                                        <input type="date" class="form-control" name="NgayKhoiChieu" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ngày Kết Thúc</label>
                                        <input type="date" class="form-control" name="NgayKetThuc" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Số Suất Chiếu / Tuần</label>
                                        <input type="number" class="form-control" name="SoSuatChieu" id="SoSuatChieu" min="1" max="36" required>
                                        <div class="invalid-feedback">Số suất chiếu phải từ 1 đến 36!</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Trạng Thái</label>
                                        <select class="form-control" name="TrangThai">
                                            <option value="1">Hoạt động</option>
                                            <option value="0">Ngừng chiếu</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Mô Tả</label>
                                        <textarea class="form-control" name="MoTa" rows="4"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Lưu Phim</button>
                                </form>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div id="AvaDiv" class="double-border">
                                <h3>Ảnh Bìa của bộ phim</h3>
                                <input type="file" id="UploadAnhBia" accept="image/*" class="form-control mb-2">
                                <img id="AnhBiaPreview" src="" class="img-fluid" style="max-height: 300px; display: none; border-radius: 10px;">
                            </div>

                            <div id="MorePic" class="double-border">
                                <h3 class="text-center mb-4">Drag & Drop để tải thêm các hình ảnh khác của phim</h3>
                                <form action="Phim/UploadFiles" class="dropzone custom-dropzone" id="myDropzone">
                                    <div class="dz-message">
                                        <i class="fas fa-cloud-upload-alt fa-3x"></i>
                                        <p>Kéo & thả hoặc nhấp để chọn ảnh</p>
                                    </div>
                                    <div id="preview-container"></div>
                                </form>
                            </div>

                            <div id="TrailerDiv" class="double-border">
                                <h3>Trailer của bộ phim</h3>
                                <div class="d-flex">
                                    <input type="text" id="TrailerInput" class="form-control me-2" placeholder="Dán link YouTube...">
                                    <button id="LoadVideo" class="btn btn-primary">Load Video</button>
                                </div>
                                <div id="TrailerPhim" class="mt-3"></div>
                            </div>
                        </div>
                    </div>                              
                <button type="button" id="uploadButton" class="btn btn-success mt-3">Tải lên</button>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- FontAwesome & Dropzone JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* Định dạng Dropzone */
    .double-border {
        border: 5px solid #343a40; /* Viền ngoài dày (màu đậm) */
        padding: 8px;
        border-radius: 10px;
        background: #fff;
        position: relative;
    }

    .double-border::before {
        content: "";
        position: absolute;
        top: 5px;
        left: 5px;
        right: 5px;
        bottom: 5px;
        border: 2px solid #6c757d; 
        border-radius: 8px;
        pointer-events: none; 
    }
    /* Thêm khoảng cách và căn giữa */
    #InfoPhim, #AvaDiv, #MorePic, #TrailerDiv {
        margin-bottom: 20px;
        padding: 20px;
    }

    /* Dropzone tùy chỉnh */
    .custom-dropzone {
        background: #f8f9fa;
        border: 2px dashed #6c757d;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    .custom-dropzone:hover {
        background-color: #e9ecef;
        border-color: #0056b3;
    }

    .dz-message {
        font-size: 20px;
        font-weight: bold;
        color: #007bff;
    }
    /* Hiển thị danh sách file */
    #preview-container {
        margin-top: 20px;
    }

    .dz-preview {
        display: inline-block;
        position: relative;
        margin: 10px;
        width: 120px;
        height: 120px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }

        .dz-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .dz-remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        text-align: center;
        line-height: 24px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0;
        transition: 0.3s;
        z-index: 9999; /* Đảm bảo nút "X" hiển thị trên ảnh */
    }

    .dz-preview:hover .dz-remove-btn {
        opacity: 1;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

@* Kéo thả ảnh *@
<script>

    $("#myModal").on("hidden.bs.modal", function () {
        $(this).removeData("bs.modal");
    });
    // Đảm bảo Dropzone không bị autoDiscover
    Dropzone.autoDiscover = false;

    // Kiểm tra và hủy bỏ Dropzone cũ nếu có
    if (Dropzone.instances && Dropzone.instances.length > 0) {
        Dropzone.instances.forEach(dz => dz.destroy());
    }

    // Khởi tạo Dropzone
    var myDropzone = new Dropzone("#myDropzone", {
        url: "/Admin/Phim/UploadFiles",
        paramName: "files",
        maxFilesize: 5,
        acceptedFiles: "image/*",
        addRemoveLinks: false, // Không dùng link mặc định
        autoProcessQueue: true,
        previewsContainer: "#preview-container", // Hiển thị file tại container riêng
        thumbnailWidth: 120,
        thumbnailHeight: 120,

        init: function () {
            var dz = this;

            dz.on("addedfile", function (file) {
                console.log("File đã thêm:", file.name);

                // Tạo nút "X"
                var removeButton = document.createElement("div");
                removeButton.className = "dz-remove-btn";
                removeButton.innerHTML = "&times;"; // Thêm dấu "X"

                console.log(removeButton); // Kiểm tra xem nút "X" có được tạo không

                // Gán sự kiện click *cho nút "X" của file cụ thể này*
                    removeButton.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        Swal.fire({
                            title: "Bạn có chắc chắn?",
                            text: "Bạn có muốn xóa ảnh này khỏi danh sách?",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Có, xóa ảnh!",
                            cancelButtonText: "Hủy"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                dz.removeFile(file); // Xóa file cụ thể này
                                Swal.fire("Đã xóa!", "Ảnh đã được xóa khỏi danh sách.", "success");
                            }
                        });
                    });


                // Tìm preview element và chèn nút "X" vào *đúng vị trí*
                var previewElement = file.previewElement;
                if (previewElement) {
                    previewElement.appendChild(removeButton);
                } else {
                    console.error("Không tìm thấy previewElement cho file:", file.name);
                }
            });
        }
    });

</script>
@* Validate suất chiếu nhỏ hơn 36 *@
<script>
    $(document).ready(function () {
        $("#phimForm").submit(function (event) {
            let soSuatChieu = $("#SoSuatChieu").val();
            if (soSuatChieu < 1 || soSuatChieu > 36) {
                $("#SoSuatChieu").addClass("is-invalid");
                event.preventDefault();
            } else {
                $("#SoSuatChieu").removeClass("is-invalid");
            }
        });
    });
</script>
@* Load Ảnh và Video  *@
<script>
    // Hiển thị ảnh bìa sau khi chọn
    document.getElementById("UploadAnhBia").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                let img = document.getElementById("AnhBiaPreview");
                img.src = e.target.result;
                img.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    // Load trailer video khi bấm nút
    document.getElementById("LoadVideo").addEventListener("click", function () {
        let url = document.getElementById("TrailerInput").value;
        let embedUrl = "";

        // Kiểm tra nếu là link YouTube hợp lệ
        let youtubeMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([^&?]+)/);
        if (youtubeMatch) {
            embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}`;
        } else {
            alert("Vui lòng nhập đường dẫn YouTube hợp lệ!");
            return;
        }

        // Gắn video vào div TrailerPhim
        document.getElementById("TrailerPhim").innerHTML = `
                <iframe width="100%" height="315" src="${embedUrl}"
                    frameborder="0" allowfullscreen></iframe>`;
    });
</script>
@*Tạo Phim gửi dữ liệu tới Controller*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $("#phimForm").submit(function (e) {
            e.preventDefault(); // Ngăn form load lại trang

            // Lấy dữ liệu từ form
            let phimData = {
                TenPhim: $("input[name='TenPhim']").val(),
                TheLoai: $("input[name='TheLoai']").val(),
                ThoiLuong: $("input[name='ThoiLuong']").val(),
                DaoDien: $("input[name='DaoDien']").val(),
                GioiHanDoTuoi: $("input[name='GioiHanDoTuoi']").val(),
                NgayKhoiChieu: $("input[name='NgayKhoiChieu']").val(),
                NgayKetThuc: $("input[name='NgayKetThuc']").val(),
                SoSuatChieu: $("input[name='SoSuatChieu']").val(),
                TrangThai: $("select[name='TrangThai']").val(),
                MoTa: $("textarea[name='MoTa']").val()
            };

            // Lấy ảnh bìa (ava) nếu có
            let avaFile = $("#UploadAnhBia")[0].files[0];

            if (avaFile) {
                let reader = new FileReader();
                reader.onloadend = function () {
                    let avaImageData = reader.result.split(',')[1]; // Lấy dữ liệu base64
                    collectDropzoneImages(phimData, avaImageData);
                };
                reader.readAsDataURL(avaFile);
            } else {
                collectDropzoneImages(phimData, null);
            }
        });

        // Lấy ảnh từ Dropzone
        function collectDropzoneImages(phimData, avaImageData) {
            let hinhAnhs = [];
            let videoLink = $("#TrailerInput").val();

            // Đưa ảnh bìa (ava) vào đầu danh sách (nếu có)
            if (avaImageData) {
                hinhAnhs.push({ Phim: null, ImageData: avaImageData });
            }

            // Lấy danh sách ảnh từ Dropzone
            let files = myDropzone.files;
            let dropzoneImages = [];

            if (files.length > 0) {
                let loadedImages = 0;
                files.forEach((file, index) => {
                    let reader = new FileReader();
                    reader.onloadend = function () {
                        dropzoneImages.push({ Phim: null, ImageData: reader.result.split(',')[1] });

                        loadedImages++;
                        if (loadedImages === files.length) {
                            // Kết hợp ảnh bìa với ảnh từ Dropzone
                            sendData(phimData, hinhAnhs.concat(dropzoneImages), videoLink);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                sendData(phimData, hinhAnhs, videoLink);
            }
        }

        // Gửi dữ liệu AJAX
        function sendData(phimData, hinhAnhs, videoLink) {
            let dataToSend = {
                PhimDatas: phimData,
                HinhAnhs: hinhAnhs,
                Videos: videoLink ? [{ Phim: null, Link: videoLink }] : []
            };

            $.ajax({
                url: "/Admin/Phim/CreateMovie",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(dataToSend),
                success: function (response) {
                    alert("Thêm phim thành công!");
                    $("#myModal").modal("hide");
                    location.reload();
                },
                error: function (xhr) {
                    alert("Lỗi: " + xhr.responseText);
                }
            });
        }
    });

    // Cấu hình Dropzone
    Dropzone.autoDiscover = false;
    var myDropzone = new Dropzone("#myDropzone", {
        url: "#",
        autoProcessQueue: false,
        acceptedFiles: "image/*",
        addRemoveLinks: true,
        dictDefaultMessage: "Kéo & thả hoặc nhấp để chọn ảnh"
    });
</script>


