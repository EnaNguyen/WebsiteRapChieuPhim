@using ProjectGSMAUI.Api.Data.Entities
@using ProjectGSMVC.Areas.Admin.ViewModels
@using ProjectGSMAUI.Api.Modal
@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var ListPhim = ViewData["ListPhim"] as List<PhimView>;
    var ListTheLoai = ViewData["ListTheLoai"] as List<TheLoaiPhim>;
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<!-- Dropzone CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">

<div class="pd-ltr-20 xs-pd-20-10">
    <div class="min-height-200px">
        <div class="page-header">
            <div class="row">
                <div class="col-md-12 col-sm-12">
                    <div class="title">
                        <h4>Quản lý Phim</h4>
                    </div>
                    <nav aria-label="breadcrumb" role="navigation">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="index.html">Trang Chủ</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                Quản lý Phim
                            </li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
        <!-- Slide Top effect -->
        <div class="container mt-3" style="margin-top: 40px; margin-bottom: 40px">
            <div class="container">
                <div class="row">
                    <div class="col-6">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal" id="ThemGiamGiaModal">
                            Thêm Phim Mới
                        </button>
                    </div>
                    <div class="col-6" style="text-align: right">
                        <input type="text" name="searching" id="Searching" placeholder="Phim Cần Tìm" style="height: 40px; width: 200px; border-radius: 5px; padding-left:20px; padding-right: 20px" />
                        <button type="submit" class="btn btn-secondary" id="ClickSearch">Tìm kiếm</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row clearfix" id="ListGiamGiaTable">
            @if (ListPhim != null && ListPhim.Any())
            {
                @foreach (var item in ListPhim)
                {
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-30">
                        <div class="da-card">
                            <div class="da-card-photo">
                                <div style="height:400px; border-bottom: 1px solid grey; width: 367.75px">
                                    @if(item.HinhAnh!=null)
                                    {
                                        <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.HinhAnh)" alt="" style="width:367.75px; height:100%" />
                                    }
                                    else
                                    {
                                        <img src="https://bcp.cdnchinhphu.vn/334894974524682240/2023/4/19/nguyen-tac-phan-loai-phim-1681809768732597109738-113-0-762-1038-crop-16818097747631607022540-1681869948152579212044.jpg" alt="" style="width:367.75px; height:100%" />
                                    }
                                </div>
                                <div class="da-overlay da-slide-top">
                                    <div class="da-social">
                                        <ul class="clearfix" style="margin-left: -25px">
                                            <li>
                                                <a href="#" class="detail-movie" data-id="@item.Id" data-bs-toggle="modal" data-bs-target="#myModal2">
                                                    <i class="bi bi-info-circle"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" class="edit-movie" data-id="@item.Id" data-bs-toggle="modal" data-bs-target="#myModal1">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" class="delete-movie" data-id="@item.Id"><i class="bi bi-x"></i></a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="da-card-content">
                                <h5 class="h5 mb-10">@item.TenPhim</h5>
                                <h5 class="h5 mb-10"><strong>Đạo Diễn: &nbsp</strong><strong style="color:red">@item.DaoDien &nbsp; </strong></h5>
                                <p class="mb-0"><strong>Từ &nbsp</strong>@item.NgayKhoiChieu &nbsp<strong>Đến </strong>@item.NgayKetThuc</p>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <p class="text-center">Không tìm thấy phim nào.</p>
                </div>
            }
        </div>
    </div>
</div>
@*Model Để thêm Phim*@
<div class="modal" id="myModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="text-align: center">
                <h3>Thêm Mới Phim</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="container">
                    <div id="phimForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div id="InfoPhim" class="double-border">

                                    <h3>Thông Tin Phim</h3>
                                    <div class="mb-3">
                                        <label class="form-label">Tên Phim</label>
                                        <input type="text" class="form-control" name="TenPhim" id="TenPhim1">
                                        <h6 id="TenPhim1error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Thể Loại</label>
                                        <select class="form-control" name="TheLoai1" id="TheLoai1">
                                            @if (ListTheLoai != null)
                                            {
                                                @foreach (var item in ListTheLoai)
                                                {
                                                    <option value="@item.Id">@item.TenTheLoai</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Thời Lượng (phút)</label>
                                        <input type="number" class="form-control" name="ThoiLuong" id="ThoiLuong1">
                                        <h6 id="ThoiLuong1error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Đạo Diễn</label>
                                        <input type="text" class="form-control" name="DaoDien" id="DaoDien1">
                                        <h6 id="DaoDien1error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Giới Hạn Độ Tuổi</label>
                                        <select class="form-control" name="GioiHanDoTuoi" id="GioiHanDoTuoi1">
                                            <option value="0">Không giới hạn độ tuổi</option>
                                            <option value="3">Theo sự hướng dẫn của cha mẹ</option>
                                            <option value="12">12+</option>
                                            <option value="16">16+</option>
                                            <option value="18">18+</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ngày Khởi Chiếu</label>
                                        <input type="date" class="form-control" name="NgayKhoiChieu" id="NgayKhoiChieu1">
                                        <h6 id="NgayKhoiChieu1error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ngày Kết Thúc</label>
                                        <input type="date" class="form-control" name="NgayKetThuc" id="NgayKetThuc1">
                                        <h6 id="NgayKetThuc1error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Số Suất Chiếu / Tuần</label>
                                        <input type="number" class="form-control" name="SoSuatChieu" id="SoSuatChieu1" min="1" max="42">
                                        <h6 id="SoSuatChieu1error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Trạng Thái</label>
                                        <select class="form-control" name="TrangThai" id="TrangThai1">
                                            <option value="1">Hoạt động</option>
                                            <option value="0">Ngừng chiếu</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Mô Tả</label>
                                        <textarea class="form-control" name="MoTa" id="MoTa1" rows="4"></textarea>
                                        <h6 id="MoTa1error"></h6>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="AvaDiv" class="double-border">
                                    <h3>Ảnh Bìa của bộ phim</h3>
                                    <input type="file" id="UploadAnhBia" accept="image/*" class="form-control mb-2">
                                    <img id="AnhBiaPreview" src="" class="img-fluid" style="max-height: 300px; display: none; border-radius: 10px;">
                                </div>

                                <div id="MorePic" class="double-border">
                                    <h3 class="text-center mb-4">Drag & Drop để tải thêm các hình ảnh khác của phim</h3>
                                    <form action="Phim/UploadFiles" class="dropzone custom-dropzone" id="myDropzone">
                                        <div class="dz-message">
                                            <i class="fas fa-cloud-upload-alt fa-3x"></i>
                                            <p>Kéo & thả hoặc nhấp để chọn ảnh</p>
                                        </div>
                                        <div id="preview-container"></div>
                                    </form>
                                </div>
                                <h6 id="HinhAnh1error"></h6>
                                <div id="TrailerDiv" class="double-border">
                                    <h3>Trailer của bộ phim</h3>
                                    <div class="d-flex">
                                        <input type="text" id="TrailerInput" class="form-control me-2" placeholder="Dán link YouTube...">
                                        <button id="LoadVideo" class="btn btn-primary">Load Video</button>
                                    </div>
                                    <div id="TrailerPhim" class="mt-3"></div>
                                </div>
                                <h6 id="Video1error"></h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="uploadButton" class="btn btn-primary">Tải lên</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@*Model Để Sửa Phim*@
<div class="modal" id="myModal1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="text-align: center">
                <h3>Chỉnh Sửa Thông Tin Phim</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="container">
                    <div id="phimForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div id="InfoPhim" class="double-border">

                                    <h3>Thông Tin Phim</h3>
                                    <div class="mb-3">
                                        <label class="form-label">Tên Phim</label>
                                        <input type="text" class="form-control" name="TenPhim" id="TenPhim2">
                                        <h6 id="TenPhim1error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Thể Loại</label>
                                        <select class="form-control" name="TheLoai1" id="TheLoai2">
                                            @if (ListTheLoai != null)
                                            {
                                                @foreach (var item in ListTheLoai)
                                                {
                                                    <option value="@item.Id">@item.TenTheLoai</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Thời Lượng (phút)</label>
                                        <input type="number" class="form-control" name="ThoiLuong" id="ThoiLuong2">
                                        <h6 id="ThoiLuong2error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Đạo Diễn</label>
                                        <input type="text" class="form-control" name="DaoDien" id="DaoDien2">
                                        <h6 id="DaoDien2error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Giới Hạn Độ Tuổi</label>
                                        <select class="form-control" name="GioiHanDoTuoi" id="GioiHanDoTuoi2">
                                            <option value="0">Không giới hạn độ tuổi</option>
                                            <option value="3">Theo sự hướng dẫn của cha mẹ</option>
                                            <option value="12">12+</option>
                                            <option value="16">16+</option>
                                            <option value="18">18+</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ngày Khởi Chiếu</label>
                                        <input type="date" class="form-control" name="NgayKhoiChieu" id="NgayKhoiChieu2">
                                        <h6 id="NgayKhoiChieu2error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ngày Kết Thúc</label>
                                        <input type="date" class="form-control" name="NgayKetThuc" id="NgayKetThuc2">
                                        <h6 id="NgayKetThuc2error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Số Suất Chiếu / Tuần</label>
                                        <input type="number" class="form-control" name="SoSuatChieu" id="SoSuatChieu2" min="1" max="42" disabled>
                                        <h6 id="SoSuatChieu2error"></h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Trạng Thái</label>
                                        <select class="form-control" name="TrangThai" id="TrangThai2">
                                            <option value="1">Hoạt động</option>
                                            <option value="0">Ngừng chiếu</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Mô Tả</label>
                                        <textarea class="form-control" name="MoTa" id="MoTa2" rows="4"></textarea>
                                        <h6 id="MoTa2error"></h6>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="AvaDiv" class="double-border">
                                    <h3>Ảnh Bìa của bộ phim</h3>
                                    <input type="file" id="UploadAnhBia1" accept="image/*" class="form-control mb-2">
                                    <img id="AnhBiaPreview1" src="" class="img-fluid" style="max-height: 300px; display: none; border-radius: 10px;">
                                </div>

                                <div id="MorePic" class="double-border">
                                    <h3 class="text-center mb-4">Drag & Drop để tải thêm các hình ảnh khác của phim</h3>
                                    <form action="Phim/UploadFiles" class="dropzone custom-dropzone" id="myDropzone1">
                                        <div class="dz-message">
                                            <i class="fas fa-cloud-upload-alt fa-3x"></i>
                                            <p>Kéo & thả hoặc nhấp để chọn ảnh</p>
                                        </div>
                                        <div id="preview-container1"></div>
                                    </form>
                                </div>
                                <h6 id="HinhAnh2error"></h6>
                                <div id="TrailerDiv" class="double-border">
                                    <h3>Trailer của bộ phim</h3>
                                    <div class="d-flex">
                                        <input type="text" id="TrailerInput1" class="form-control me-2" placeholder="Dán link YouTube...">
                                        <button id="LoadVideo1" class="btn btn-primary">Load Video</button>
                                    </div>
                                    <div id="TrailerPhim1" class="mt-3"></div>
                                </div>
                                <h6 id="Video1error"></h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="uploadButton1" class="btn btn-primary">Tải lên</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div> 

<!-- FontAwesome & Dropzone JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* Định dạng Dropzone */
    .double-border {
        border: 5px solid #343a40; /* Viền ngoài dày (màu đậm) */
        padding: 8px;
        border-radius: 10px;
        background: #fff;
        position: relative;
    }

    .double-border::before {
        content: "";
        position: absolute;
        top: 5px;
        left: 5px;
        right: 5px;
        bottom: 5px;
        border: 2px solid #6c757d; 
        border-radius: 8px;
        pointer-events: none; 
    }
    /* Thêm khoảng cách và căn giữa */
    #InfoPhim, #AvaDiv, #MorePic, #TrailerDiv {
        margin-bottom: 20px;
        padding: 20px;
    }

    /* Dropzone tùy chỉnh */
    .custom-dropzone {
        background: #f8f9fa;
        border: 2px dashed #6c757d;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    .custom-dropzone:hover {
        background-color: #e9ecef;
        border-color: #0056b3;
    }

    .dz-message {
        font-size: 20px;
        font-weight: bold;
        color: #007bff;
    }
    /* Hiển thị danh sách file */
    #preview-container {
        margin-top: 20px;
    }

    .dz-preview {
        display: inline-block;
        position: relative;
        margin: 10px;
        width: 120px;
        height: 120px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }

        .dz-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .dz-remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        text-align: center;
        line-height: 24px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0;
        transition: 0.3s;
        z-index: 9999; /* Đảm bảo nút "X" hiển thị trên ảnh */
    }

    .dz-preview:hover .dz-remove-btn {
        opacity: 1;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

@* Kéo thả ảnh *@
<script>

    $("#myModal").on("hidden.bs.modal", function () {
        $(this).removeData("bs.modal");
    });
    // Đảm bảo Dropzone không bị autoDiscover
    Dropzone.autoDiscover = false;

    // Kiểm tra và hủy bỏ Dropzone cũ nếu có
    if (Dropzone.instances && Dropzone.instances.length > 0) {
        Dropzone.instances.forEach(dz => dz.destroy());
    }

    // Khởi tạo Dropzone
    var myDropzone = new Dropzone("#myDropzone", {
        url: "/Admin/Phim/UploadFiles",
        paramName: "files",
        maxFilesize: 5,
        acceptedFiles: "image/*",
        addRemoveLinks: false, 
        autoProcessQueue: true,
        previewsContainer: "#preview-container", 
        thumbnailWidth: 120,
        thumbnailHeight: 120,

        init: function () {
            var dz = this;

            dz.on("addedfile", function (file) {
                console.log("File đã thêm:", file.name);

                // Tạo nút "X"
                var removeButton = document.createElement("div");
                removeButton.className = "dz-remove-btn";
                removeButton.innerHTML = "&times;"; // Thêm dấu "X"

                console.log(removeButton); // Kiểm tra xem nút "X" có được tạo không

                // Gán sự kiện click *cho nút "X" của file cụ thể này*
                    removeButton.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        Swal.fire({
                            title: "Bạn có chắc chắn?",
                            text: "Bạn có muốn xóa ảnh này khỏi danh sách?",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Có, xóa ảnh!",
                            cancelButtonText: "Hủy"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                dz.removeFile(file); // Xóa file cụ thể này
                                Swal.fire("Đã xóa!", "Ảnh đã được xóa khỏi danh sách.", "success");
                            }
                        });
                    });


                // Tìm preview element và chèn nút "X" vào *đúng vị trí*
                var previewElement = file.previewElement;
                if (previewElement) {
                    previewElement.appendChild(removeButton);
                } else {
                    console.error("Không tìm thấy previewElement cho file:", file.name);
                }
            });
        }
    });

</script>

@* Load Ảnh và Video  *@
<script>
    // Hiển thị ảnh bìa sau khi chọn
    document.getElementById("UploadAnhBia").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                let img = document.getElementById("AnhBiaPreview");
                img.src = e.target.result;
                img.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    // Load trailer video khi bấm nút
    document.getElementById("LoadVideo").addEventListener("click", function () {
        let url = document.getElementById("TrailerInput").value;
        let embedUrl = "";

        // Kiểm tra nếu là link YouTube hợp lệ
        let youtubeMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([^&?]+)/);
        if (youtubeMatch) {
            embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}`;
        } else {
            alert("Vui lòng nhập đường dẫn YouTube hợp lệ!");
            return;
        }

        // Gắn video vào div TrailerPhim
        document.getElementById("TrailerPhim").innerHTML = `
                <iframe width="100%" height="315" src="${embedUrl}"
                    frameborder="0" allowfullscreen></iframe>`;
    });
</script>

@*Tạo Phim gửi dữ liệu tới Controller*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $("#uploadButton").click(function (e) {
            e.preventDefault();
            console.log("Hello?");

            // Tạo đối tượng phimData với đầy đủ các key, nếu trường nào không có dữ liệu thì gán null
            let phimData = {
                TenPhim: $("#TenPhim1").val() || null,
                TheLoai: $("#TheLoai1").val() || null,
                ThoiLuong: $("#ThoiLuong1").val() ? parseInt($("#ThoiLuong1").val()) : null,
                DaoDien: $("#DaoDien1").val() || null,
                GioiHanDoTuoi: $("#GioiHanDoTuoi1").val() ? parseInt($("#GioiHanDoTuoi1").val()) : null,
                NgayKhoiChieu: $("#NgayKhoiChieu1").val() || null,
                NgayKetThuc: $("#NgayKetThuc1").val() || null,
                SoSuatChieu: $("#SoSuatChieu1").val() ? parseInt($("#SoSuatChieu1").val()) : null,
                TrangThai: $("#TrangThai1").val() ? parseInt($("#TrangThai1").val()) : null,
                MoTa: $("#MoTa1").val() || null
            };

            // Lấy file ảnh bìa
            let avaFile = $("#UploadAnhBia")[0].files[0];
            console.log(avaFile);
            console.log(phimData);

            if (avaFile) {
                let reader = new FileReader();
                reader.onloadend = function () {
                    console.log("if");
                    let avaImageData = reader.result.split(',')[1];
                    collectDropzoneImages(phimData, avaImageData);
                };
                reader.readAsDataURL(avaFile);
            } else {
                console.log("else");
                collectDropzoneImages(phimData, null);
            }

            function collectDropzoneImages(phimData, avaImageData) {
                let hinhAnhs = [];
                // Lấy giá trị của video (nếu có); nếu không có thì gán null
                let videoLink = $("#TrailerInput").val() || null;

                // Nếu có file avatar thì đưa vào mảng
                if (avaImageData) {
                    hinhAnhs.push({ Phim: null, ImageData: avaImageData });
                }
                // Lấy danh sách file từ Dropzone
                let myDropzone = Dropzone.forElement("#myDropzone");
                let files = myDropzone.files || [];

                if (files.length > 0) {
                    let dropzoneImages = [];
                    let loadedImages = 0;

                    files.forEach((file, index) => {
                        let reader = new FileReader();
                        reader.onloadend = function () {
                            dropzoneImages.push({ Phim: null, ImageData: reader.result.split(',')[1] });
                            loadedImages++;
                            if (loadedImages === files.length) {
                                // Nếu chưa chọn ảnh avatar (avaFile == null) và có ảnh trong dropzone, hỏi người dùng
                                if (!avaFile && dropzoneImages.length > 0) {
                                    Swal.fire({
                                        title: "Chọn ảnh làm Avatar?",
                                        text: "Bạn chưa chọn ảnh Avatar cho bộ phim, bạn có muốn lấy ảnh đầu tiên trong số những bức ảnh khác của bạn làm avatar không?",
                                        icon: "warning",
                                        showCancelButton: true,
                                        confirmButtonColor: "#3085d6",
                                        cancelButtonColor: "#d33",
                                        confirmButtonText: "Có!",
                                        cancelButtonText: "Hủy"
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            sendData(phimData, hinhAnhs.concat(dropzoneImages), videoLink);
                                        }
                                    });
                                } else {
                                    sendData(phimData, hinhAnhs.concat(dropzoneImages), videoLink);
                                }
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    if (!avaFile) {
                        Swal.fire({
                            title: "Lỗi",
                            text: "Bạn cần tải lên ít nhất một ảnh!",
                            icon: "error"
                        });
                    } else {
                        sendData(phimData, hinhAnhs, videoLink);
                    }
                }
            }

            // Hàm gửi dữ liệu AJAX
            function sendData(phimData, hinhAnhs, videoLink) {
                // Đảm bảo rằng nếu không có hình ảnh hoặc video thì gán mảng rỗng
                let dataToSend = {
                    PhimDatas: phimData,
                    HinhAnhs: hinhAnhs || [],
                    Videos: videoLink ? [{ Phim: null, Link: videoLink }] : []
                };
                console.log("Data to send:", dataToSend);
                $.ajax({
                    url: "/Admin/Phim/CreateMovie",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(dataToSend),
                    success: function (response) {
                        alert("Thêm phim thành công!");
                        $("#myModal").modal("hide");
                        location.reload();
                    },
                    error: function (xhr) {
                        var errors = xhr.responseJSON;
                        console.log(errors);
                        $("h6").text("").css("color", "");
                        if (errors.TenPhim) $("#TenPhim1error").text(errors.TenPhim).css("color", "red");
                        if (errors.ThoiLuong) $("#ThoiLuong1error").text(errors.ThoiLuong).css("color", "red");
                        if (errors.DaoDien) $("#DaoDien1error").text(errors.DaoDien).css("color", "red");
                        if (errors.GioiHanDoTuoi) $("#GioiHanDoTuoi1error").text(errors.GioiHanDoTuoi).css("color", "red");
                        if (errors.NgayKhoiChieu) $("#NgayKhoiChieu1error").text(errors.NgayKhoiChieu).css("color", "red");
                        if (errors.NgayKetThuc) $("#NgayKetThuc1error").text(errors.NgayKetThuc).css("color", "red");
                        if (errors.SoSuatChieu) $("#SoSuatChieu1error").text(errors.SoSuatChieu).css("color", "red");
                        if (errors.MoTa) $("#MoTa1error").text(errors.MoTa).css("color", "red");
                        if (errors.Videos) $("#Video1error").text(errors.Videos).css("color", "red");
                    }
                });
            }
        });
    });
</script>

@*Load dữ liệu lên Modal*@
<script>
    let oldImages = [];
    let Edited = 0;
    let AvatarEdit = [];
    $(document).ready(function () {
        AvatarEdit = [];
        oldImages = [];
        $(".edit-movie").on("click", function (e) {
            $("#preview-container1").empty();
            if (Dropzone.forElement("#myDropzone1")) {
                Dropzone.forElement("#myDropzone1").removeAllFiles(true);
            }
            $("TrailerInput1").val("");
            $("#AnhBiaPreview1").attr("src", "").show();
            e.preventDefault();
            document.getElementById("TrailerPhim1").innerHTML = ``;
            var movieId = $(this).data("id");
            Edited = parseInt(movieId);
            console.log(Edited);
            $.ajax({
                url: "/Admin/Phim/GetPhim",
                type: "GET",
                data: { id: movieId },
                dataType: "json",
                success: function (response) {
                    console.log(response);
                    if (response.success) {
                        var phim = response.data;
                        var hinhAnhs = response.data.hinhAnhs;
                        oldImages = [...hinhAnhs]; // Copy dữ liệu cũ

                        var avatar = hinhAnhs.find(img => img.avatar === true);
                        if (avatar) {
                            $("#AnhBiaPreview1").attr("src", "data:image/png;base64," + avatar.imageData).show();
                            AvatarEdit = oldImages[0];
                            console.log(AvatarEdit)
                        }

                        $("#TenPhim2").val(phim.movies.tenPhim);
                        $("#ThoiLuong2").val(phim.movies.thoiLuong);
                        $("#DaoDien2").val(phim.movies.daoDien);
                        $("#GioiHanDoTuoi2").val(phim.movies.gioiHanDoTuoi);
                        $("#NgayKhoiChieu2").val(phim.movies.ngayKhoiChieu);
                        $("#NgayKetThuc2").val(phim.movies.ngayKetThuc);
                        $("#SoSuatChieu2").val(phim.movies.soSuatChieu);
                        $("#TrangThai2").val(phim.movies.trangThai);
                        $("#MoTa2").val(phim.movies.moTa);

                        $("#TheLoai2").val(phim.movies.theLoai).trigger("change");

                        var myDropzone2 = Dropzone.forElement("#myDropzone1");
                        myDropzone2.removeAllFiles(true);

                        oldImages.forEach(img => {
                            if (!img.avatar) {
                                let mockFile = { name: img.id, size: 12345 };
                                myDropzone2.emit("addedfile", mockFile);
                                myDropzone2.emit("thumbnail", mockFile, "data:image/png;base64," + img.imageData);
                                myDropzone2.emit("complete", mockFile);
                            }
                        });
                        console.log(phim.vidoes)
                        if (phim.videos && Array.isArray(phim.videos) && phim.videos.length > 0 && phim.videos[0].link) {
                            let videoLink = phim.videos[0].link;
                            let embedUrl = `https://www.youtube.com/embed/${videoLink}`;

                            $("#TrailerInput1").val(videoLink);
                            $("#TrailerPhim1").html(`<iframe width="100%" height="315" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`);
                            console.log("Lỗi ở if");
                        } else {
                            $("#TrailerInput1").val("");
                            $("#TrailerPhim1").empty();
                            console.log("Lỗi ở else: phim.videos không hợp lệ hoặc không có video nào.");
                        }
                        $("#myModal1").modal("show");
                    } else {
                        console.log("Lỗi:", response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Có lỗi xảy ra:", error);
                }
            });
        });
    });

    $("#myModal1").on("hidden.bs.modal", function () {
        console.log("Modal đóng, dữ liệu vẫn giữ nguyên");
    });

    // Khởi tạo Dropzone
    var myDropzone1 = new Dropzone("#myDropzone1", {
        url: "/Admin/Phim/UploadFiles",
        paramName: "files",
        maxFilesize: 5,
        acceptedFiles: "image/*",
        addRemoveLinks: false,
        autoProcessQueue: true,
        previewsContainer: "#preview-container1",
        thumbnailWidth: 120,
        thumbnailHeight: 120,

        init: function () {
            var dz = this;

            dz.on("success", function (file, response) {
                console.log("File đã tải lên thành công:", file.name);
                let previewImg = $(file.previewElement).find("img").attr("src");
                oldImages.push({ id: file.name, imageData: previewImg, avatar: false });
                console.log(oldImages);
            });

            dz.on("addedfile", function (file) {
                var removeButton = document.createElement("div");
                removeButton.className = "dz-remove-btn";
                removeButton.innerHTML = "&times;";
                removeButton.addEventListener("click", function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    Swal.fire({
                        title: "Bạn có chắc chắn?",
                        text: "Bạn có muốn xóa ảnh này khỏi danh sách?",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Có, xóa ảnh!",
                        cancelButtonText: "Hủy"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            dz.removeFile(file);
                            oldImages = oldImages.filter(img => img.id !== file.name && img.id);
                            oldImages = oldImages.filter(img => img.id !== file.name && img.id);
                            oldImages = JSON.parse(JSON.stringify(oldImages));
                            Swal.fire("Đã xóa!", "Ảnh đã được xóa khỏi danh sách.", "success");
                            console.log(oldImages);
                        }
                    });
                });

                var previewElement = file.previewElement;
                if (previewElement) {
                    previewElement.appendChild(removeButton);
                } else {
                    console.error("Không tìm thấy previewElement cho file:", file.name);
                }
            });
        }
    });

    // Xử lý video YouTube
    document.getElementById("LoadVideo1").addEventListener("click", function () {
        let url = document.getElementById("TrailerInput1").value;
        let embedUrl = "";

        let youtubeMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([^&?]+)/);
        if (youtubeMatch) {
            embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}`;
        } else {
            alert("Vui lòng nhập đường dẫn YouTube hợp lệ!");
            return;
        }

        document.getElementById("TrailerPhim1").innerHTML = `
            <iframe width="100%" height="315" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
    });
</script>
@*Thay đổi dữ liệu của phim*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $("#uploadButton1").click(function (e) {
            e.preventDefault(); 
            let phimData = {
                TenPhim: $("#TenPhim2").val(),
                TheLoai: $("#TheLoai2").val(),
                ThoiLuong: $("#ThoiLuong2").val(),
                DaoDien: $("#DaoDien2").val(),
                GioiHanDoTuoi: $("#GioiHanDoTuoi2").val(),
                NgayKhoiChieu: $("#NgayKhoiChieu2").val(),
                NgayKetThuc: $("#NgayKetThuc2").val(),
                SoSuatChieu: $("#SoSuatChieu2").val(),
                TrangThai: $("#TrangThai2").val(),
                MoTa: $("#MoTa2").val()
            };
            let avaFile = $("#UploadAnhBia1")[0].files[0];
            console.log(phimData);
            if (avaFile) {
                let reader = new FileReader();
                reader.onloadend = function () {
                    console.log("if");
                    let avaImageData = reader.result.split(',')[1];
                    collectDropzoneImages1(phimData, avaImageData);
                };
                reader.readAsDataURL(avaFile);
            } else {
                collectDropzoneImages1(phimData, null);
            }
            function collectDropzoneImages1(phimData, avaImageData) {
                let hinhAnhs = [];
                let videoLink = $("#TrailerInput1").val();

                if (avaImageData) {
                    hinhAnhs.push({ Phim: null, ImageData: avaImageData });
                }

                let myDropzoneInstance = Dropzone.forElement("#myDropzone1");
                let files = myDropzoneInstance.files || [];

                if (files.length === 0) {
                    if (oldImages && oldImages.length > 0) {
                        let formattedOldImages = oldImages.map(img => ({ Phim: null, ImageData: img.imageData }));
                        sendData1(phimData, formattedOldImages, videoLink);
                    } else {
                        Swal.fire({
                            title: "Lỗi",
                            text: "Bạn cần tải lên ít nhất một ảnh!",
                            icon: "error"
                        });
                    }
                    return; 
                }
                let dropzoneImages = [];
                let loadedImages = 0;
                files.forEach((file, index) => {
                    let reader = new FileReader();
                    reader.onloadend = function () {
                        dropzoneImages.push({ Phim: null, ImageData: reader.result.split(',')[1] });
                        loadedImages++;
                        if (loadedImages === files.length) {
                            if (!avaFile && !AvatarEdit && oldImages > 0) {
                                Swal.fire({
                                    title: "Chọn ảnh làm Avatar?",
                                    text: "Bạn chưa chọn ảnh Avatar cho bộ phim, bạn có muốn lấy ảnh đầu tiên trong số những bức ảnh khác của bạn làm avatar không?",
                                    icon: "warning",
                                    showCancelButton: true,
                                    confirmButtonColor: "#3085d6",
                                    cancelButtonColor: "#d33",
                                    confirmButtonText: "Có!",
                                    cancelButtonText: "Hủy"
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        sendData1(phimData, hinhAnhs.concat(oldImages), videoLink);
                                    }
                                });
                            } else {
                                sendData1(phimData, hinhAnhs.concat(oldImages), videoLink);
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            // Gửi dữ liệu AJAX
            function sendData1(phimData, hinhAnhs, videoLink) {
                let DuLieuPhim = {
                    PhimDatas: phimData,
                    HinhAnhs: hinhAnhs,
                    Videos: videoLink ? [{ Phim: null, Link: videoLink }] : []
                };
                let dataToSend =
                    {
                        model : DuLieuPhim,
                        idPhim : Edited,
                    }
                console.log(dataToSend);
                $.ajax({
                    url: "/Admin/Phim/Update",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(dataToSend),
                    success: function (response) {
                        alert("Thêm phim thành công!");
                        $("#myModal1").modal("hide");
                        location.reload();
                    },
                    error: function (xhr) {
                        var errors = xhr.responseJSON;
                        console.log(errors)
                        $("h6").text("").css("color", "");
                        if (errors.TenPhim) $("#TenPhim2error").text(errors.TenPhim).css("color", "red");
                        if (errors.ThoiLuong) $("#ThoiLuong2error").text(errors.ThoiLuong).css("color", "red");
                        if (errors.DaoDien) $("#DaoDien2error").text(errors.DaoDien).css("color", "red");
                        if (errors.GioiHanDoTuoi) $("#GioiHanDoTuoi2error").text(errors.GioiHanDoTuoi).css("color", "red");
                        if (errors.NgayKhoiChieu) $("#NgayKhoiChieu2error").text(errors.NgayKhoiChieu).css("color", "red");
                        if (errors.NgayKetThuc) $("#NgayKetThuc2error").text(errors.NgayKetThuc).css("color", "red");
                        if (errors.SoSuatChieu) $("#SoSuatChieu2error").text(errors.SoSuatChieu).css("color", "red");
                        console.log(errors.MoTa)
                        if (errors.MoTa) $("#MoTa2error").text(errors.MoTa).css("color", "red");
                        console.log(errors.Videos)
                        if (errors.Videos) $("#Video2error").text(errors.Videos).css("color", "red");
                    }
                });
            }
        });
    });
</script>


